<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Pedidos - Admin NovaShop</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.parameterName}"/>
  <link rel="stylesheet" th:href="@{/css/dashboard.css}">
  <link rel="stylesheet" th:href="@{/css/admi-pedido.css}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

</head>
<body>
<!-- Topbar -->
<nav class="admin-topbar">
  <div class="d-flex align-items-center">
    <a th:href="@{/admin}" class="admin-logo">
      <i class="bi bi-shield-check"></i>
      <span>NovaShop Admin</span>
    </a>
  </div>

  <div class="d-flex align-items-center gap-3">
    <div class="dropdown">
      <button class="btn btn-link text-dark position-relative" data-bs-toggle="dropdown">
        <i class="bi bi-bell fs-5"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              th:if="${pedidosPendientes > 0}"
              th:text="${pedidosPendientes}">0</span>
      </button>
    </div>

    <div class="dropdown">
      <button class="btn btn-link text-dark d-flex align-items-center" data-bs-toggle="dropdown">
        <i class="bi bi-person-circle fs-4 me-2"></i>
        <span sec:authentication="name">Admin</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" th:href="@{/}"><i class="bi bi-shop me-2"></i> Ver Tienda</a></li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <form th:action="@{/logout}" method="post">
            <button type="submit" class="dropdown-item text-danger">
              <i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión
            </button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Sidebar -->
<aside class="admin-sidebar">
  <ul class="sidebar-nav">
    <li class="nav-section-title">Principal</li>
    <li class="sidebar-nav-item">
      <a th:href="@{/admin}" class="sidebar-nav-link">
        <i class="bi bi-speedometer2"></i>
        <span>Dashboard</span>
      </a>
    </li>

    <li class="nav-section-title">Gestión</li>
    <li class="sidebar-nav-item">
      <a th:href="@{/admin/productos}" class="sidebar-nav-link">
        <i class="bi bi-box-seam"></i>
        <span>Productos</span>
      </a>
    </li>
    <li class="sidebar-nav-item">
      <a th:href="@{/admin/categorias}" class="sidebar-nav-link">
        <i class="bi bi-grid-3x3"></i>
        <span>Categorías</span>
      </a>
    </li>
    <li class="sidebar-nav-item">
      <a th:href="@{/admin/pedidos}" class="sidebar-nav-link active">
        <i class="bi bi-clipboard-check"></i>
        <span>Pedidos</span>
        <span class="badge bg-danger ms-auto"
              th:if="${pedidosPendientes > 0}"
              th:text="${pedidosPendientes}">0</span>
      </a>
    </li>
    <li class="sidebar-nav-item">
      <a th:href="@{/admin/usuarios}" class="sidebar-nav-link">
        <i class="bi bi-people"></i>
        <span>Usuarios</span>
      </a>
    </li>
  </ul>
</aside>

<!-- Main Content -->
<main class="admin-main">
  <!-- Alertas -->
  <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show">
    <i class="bi bi-check-circle me-2"></i>
    <span th:text="${mensaje}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <!-- Page Header -->
  <div class="mb-4">
    <h1 class="h3 fw-bold mb-1">
      <i class="bi bi-clipboard-check me-2"></i>
      Gestión de Pedidos
    </h1>
    <p class="text-muted">
      Total: <strong th:text="${pedidos.totalElements}">0</strong> pedidos
    </p>
  </div>

  <!-- Mini Stats -->
  <div class="stats-mini">
    <div class="stat-mini">
      <div class="stat-mini-icon warning">
        <i class="bi bi-hourglass-split"></i>
      </div>
      <div>
        <p class="stat-mini-value"
           th:text="${pedidosPendientes != null ? pedidosPendientes : 0}">0</p>
        <p class="stat-mini-label">Pendientes</p>
      </div>
    </div>

    <div class="stat-mini">
      <div class="stat-mini-icon info">
        <i class="bi bi-truck"></i>
      </div>
      <div>
        <p class="stat-mini-value">0</p>
        <p class="stat-mini-label">En Camino</p>
      </div>
    </div>

    <div class="stat-mini">
      <div class="stat-mini-icon success">
        <i class="bi bi-check-circle"></i>
      </div>
      <div>
        <p class="stat-mini-value">0</p>
        <p class="stat-mini-label">Completados Hoy</p>
      </div>
    </div>

    <div class="stat-mini">
      <div class="stat-mini-icon danger">
        <i class="bi bi-x-circle"></i>
      </div>
      <div>
        <p class="stat-mini-value">0</p>
        <p class="stat-mini-label">Cancelados</p>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <form th:action="@{/admin/pedidos}" method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label small fw-semibold text-muted">Estado del Pedido</label>
        <select class="form-select" name="estado">
          <option value="">Todos los Estados</option>
          <option value="PENDIENTE"
                  th:selected="${param.estado != null && param.estado[0] == 'PENDIENTE'}">
            Pendiente
          </option>
          <option value="CONFIRMADO"
                  th:selected="${param.estado != null && param.estado[0] == 'CONFIRMADO'}">
            Confirmado
          </option>
          <option value="PROCESANDO"
                  th:selected="${param.estado != null && param.estado[0] == 'PROCESANDO'}">
            Procesando
          </option>
          <option value="ENVIADO"
                  th:selected="${param.estado != null && param.estado[0] == 'ENVIADO'}">
            Enviado
          </option>
          <option value="ENTREGADO"
                  th:selected="${param.estado != null && param.estado[0] == 'ENTREGADO'}">
            Entregado
          </option>
          <option value="CANCELADO"
                  th:selected="${param.estado != null && param.estado[0] == 'CANCELADO'}">
            Cancelado
          </option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label small fw-semibold text-muted">Ordenar Por</label>
        <select class="form-select" name="orden">
          <option value="reciente">Más Recientes</option>
          <option value="antiguo">Más Antiguos</option>
          <option value="mayor">Mayor Valor</option>
          <option value="menor">Menor Valor</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label small fw-semibold text-muted">Buscar</label>
        <input type="text"
               class="form-control"
               name="buscar"
               th:value="${param.buscar}"
               placeholder="Número de pedido o cliente...">
      </div>

      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search me-2"></i> Filtrar
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de Pedidos -->
  <div class="content-card">

    <!-- Sin pedidos -->
    <div class="empty-state" th:if="${pedidos.empty}">
      <i class="bi bi-inbox"></i>
      <h4 class="mt-3">No se encontraron pedidos</h4>
      <p class="text-muted">
        No hay pedidos que coincidan con los filtros seleccionados.
      </p>
    </div>

    <!-- Con pedidos -->
    <div th:if="${!pedidos.empty}">
      <div class="order-row"
           th:each="pedido : ${pedidos.content}"
           onclick="window.location.href='/admin/pedidos/' + [[${pedido.idPedido}]]">

        <div class="row align-items-center">

          <!-- Info del Pedido -->
          <div class="col-lg-3">
            <div class="order-number" th:text="${pedido.numeroPedido}">
              NS-202510-001234
            </div>
            <div class="order-customer">
              <i class="bi bi-person me-1"></i>
              <span th:text="${pedido.usuario.nombre + ' ' + pedido.usuario.apellido}">
                                Cliente
                            </span>
            </div>
            <div class="order-date">
              <i class="bi bi-calendar3 me-1"></i>
              <span th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy HH:mm')}">
                                31/10/2025 14:30
                            </span>
            </div>
          </div>

          <!-- Items y Método de Pago -->
          <div class="col-lg-3">
            <div class="items-count mb-2">
              <i class="bi bi-box"></i>
              <span th:text="${pedido.detalles.size()} + ' producto' + (${pedido.detalles.size()} > 1 ? 's' : '')">
                                3 productos
                            </span>
            </div>
            <div class="payment-method">
              <i class="bi bi-credit-card"></i>
              <span th:text="${pedido.metodoPago}">TARJETA</span>
            </div>
          </div>

          <!-- Total -->
          <div class="col-lg-2 text-center">
            <div class="order-total"
                 th:text="'S/ ' + ${#numbers.formatDecimal(pedido.total, 1, 2)}">
              S/ 284.70
            </div>
          </div>

          <!-- Estado -->
          <div class="col-lg-2 text-center">
                        <span class="status-badge"
                              th:classappend="'status-' + ${pedido.estado.name()}">
                            <i class="bi bi-circle-fill"></i>
                            <span th:text="${pedido.estado}">PENDIENTE</span>
                        </span>
          </div>

          <!-- Acciones -->
          <div class="col-lg-2 text-end">
            <div class="quick-actions" onclick="event.stopPropagation()">
              <a th:href="@{/admin/pedidos/{id}(id=${pedido.idPedido})}"
                 class="btn btn-sm btn-outline-primary btn-quick-action"
                 title="Ver Detalles">
                <i class="bi bi-eye"></i>
              </a>

              <button type="button"
                      class="btn btn-sm btn-outline-success btn-quick-action"
                      th:if="${pedido.estado == T(com.example.novashop.model.Pedido.EstadoPedido).PENDIENTE}"
                      th:onclick="'cambiarEstado(' + ${pedido.idPedido} + ', \'CONFIRMADO\')'"
                      title="Confirmar Pedido">
                <i class="bi bi-check"></i>
              </button>

              <button type="button"
                      class="btn btn-sm btn-outline-info btn-quick-action"
                      th:if="${pedido.estado == T(com.example.novashop.model.Pedido.EstadoPedido).CONFIRMADO}"
                      th:onclick="'cambiarEstado(' + ${pedido.idPedido} + ', \'PROCESANDO\')'"
                      title="Marcar como Procesando">
                <i class="bi bi-arrow-right"></i>
              </button>

              <button type="button"
                      class="btn btn-sm btn-outline-danger btn-quick-action"
                      th:if="${pedido.estado != T(com.example.novashop.model.Pedido.EstadoPedido).CANCELADO
                                           && pedido.estado != T(com.example.novashop.model.Pedido.EstadoPedido).ENTREGADO}"
                      th:onclick="'cancelarPedido(' + ${pedido.idPedido} + ')'"
                      title="Cancelar Pedido">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginación -->
    <nav th:if="${pedidos.totalPages > 1}" class="mt-4">
      <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${pedidos.first} ? 'disabled'">
          <a class="page-link"
             th:href="@{/admin/pedidos(page=${pedidos.number - 1}, estado=${param.estado})}">
            <i class="bi bi-chevron-left"></i>
          </a>
        </li>

        <li class="page-item"
            th:each="i : ${#numbers.sequence(0, pedidos.totalPages - 1)}"
            th:if="${i >= (pedidos.number - 2) && i <= (pedidos.number + 2)}"
            th:classappend="${i == pedidos.number} ? 'active'">
          <a class="page-link"
             th:href="@{/admin/pedidos(page=${i}, estado=${param.estado})}"
             th:text="${i + 1}">1</a>
        </li>

        <li class="page-item" th:classappend="${pedidos.last} ? 'disabled'">
          <a class="page-link"
             th:href="@{/admin/pedidos(page=${pedidos.number + 1}, estado=${param.estado})}">
            <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Cambiar estado del pedido
  function cambiarEstado(idPedido, nuevoEstado) {
      if (confirm(`¿Cambiar el estado del pedido a ${nuevoEstado}?`)) {
          // Crear formulario dinámico
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/admin/pedidos/${idPedido}/cambiar-estado`;

          // --- INICIO DE LA CORRECCIÓN CSRF ---

          // 1. Buscar los elementos meta que acabamos de añadir
          const csrfTokenEl = document.querySelector('meta[name="_csrf"]');
          const csrfHeaderEl = document.querySelector('meta[name="_csrf_header"]');

          if (csrfTokenEl && csrfHeaderEl) {
              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';

              // 2. Asignación CORREGIDA
              // El 'name' es el contenido del header (ej: "_csrf")
              csrfInput.name = csrfHeaderEl.getAttribute('content');
              // El 'value' es el contenido del token (el código largo)
              csrfInput.value = csrfTokenEl.getAttribute('content');

              form.appendChild(csrfInput);
          } else {
              // Si no encontramos los tokens, paramos y avisamos.
              console.error('Meta tags CSRF no encontradas. El envío fallará.');
              alert('Error de seguridad. No se pudo procesar la solicitud.');
              return;
          }
          // --- FIN DE LA CORRECCIÓN CSRF ---

          // Estado
          const estadoInput = document.createElement('input');
          estadoInput.type = 'hidden';
          estadoInput.name = 'nuevoEstado';
          estadoInput.value = nuevoEstado;
          form.appendChild(estadoInput);

          document.body.appendChild(form);
          form.submit();
      }
  }

  // Cancelar pedido
  function cancelarPedido(idPedido) {
      if (confirm('¿Estás seguro de que deseas CANCELAR este pedido?\n\nEsta acción no se puede deshacer.')) {
          cambiarEstado(idPedido, 'CANCELADO');
      }
  }

  // Auto-cerrar alertas
  setTimeout(function() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(function(alert) {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
      });
  }, 5000);
</script>

</body>
</html>