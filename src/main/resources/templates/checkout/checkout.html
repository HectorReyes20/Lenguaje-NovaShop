<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - NovaShop</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/checkout.css}">
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- Alertas -->
<div th:replace="~{fragments/navbar :: alerts}"></div>

<!-- Checkout Page -->
<section class="checkout-page">
    <div class="container">

        <!-- Header con Pasos -->
        <div class="checkout-header">
            <h1 class="display-6 fw-bold mb-4">
                <i class="bi bi-credit-card me-3"></i>Finalizar Compra
            </h1>

            <div class="checkout-steps">
                <div class="checkout-step completed">
                    <div class="step-circle">
                        <i class="bi bi-check"></i>
                    </div>
                    <div class="step-label">Carrito</div>
                </div>

                <div class="checkout-step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">Env√≠o y Pago</div>
                </div>

                <div class="checkout-step">
                    <div class="step-circle">3</div>
                    <div class="step-label">Confirmaci√≥n</div>
                </div>
            </div>
        </div>

        <form th:action="@{/checkout/procesar}" method="post" id="checkoutForm">
            <div class="row">

                <!-- Formulario Principal -->
                <div class="col-lg-7">

                    <!-- Direcci√≥n de Env√≠o -->
                    <div class="checkout-section">
                        <h3 class="section-title">
                            <i class="bi bi-geo-alt-fill"></i>
                            Direcci√≥n de Env√≠o
                        </h3>

                        <!-- Sin Direcciones -->
                        <div th:if="${direcciones.isEmpty()}" class="text-center py-4">
                            <i class="bi bi-house-x fs-1 text-muted mb-3"></i>
                            <p class="text-muted mb-3">No tienes direcciones guardadas</p>
                            <a th:href="@{/mi-cuenta/direcciones/nueva}" class="btn-add-address">
                                <i class="bi bi-plus-circle me-2"></i>
                                Agregar Nueva Direcci√≥n
                            </a>
                        </div>

                        <!-- Lista de Direcciones -->
                        <div th:if="${!direcciones.isEmpty()}">
                            <div th:each="dir, iterStat : ${direcciones}">
                                <label class="address-card"
                                       th:classappend="${iterStat.first} ? 'selected' : ''">
                                    <input type="radio"
                                           name="idDireccionEnvio"
                                           th:value="${dir.idDireccion}"
                                           th:checked="${iterStat.first}"
                                           required
                                           onchange="selectAddress(this)">

                                    <div class="address-name">
                                        <i class="bi bi-person-fill me-2"></i>
                                        <span th:text="${dir.nombreCompleto}">Juan P√©rez</span>

                                        <span class="badge bg-success ms-2" th:if="${dir.esPredeterminada}">
                                            Principal
                                        </span>
                                    </div>

                                    <div class="address-details">
                                        <p class="mb-1">
                                            <i class="bi bi-geo-alt me-2"></i>
                                            <span th:text="${dir.direccionLinea1}">Av. Principal 123</span>
                                        </p>
                                        <p class="mb-1" th:if="${dir.direccionLinea2 != null}">
                                            <span th:text="${dir.direccionLinea2}"></span>
                                        </p>
                                        <p class="mb-1">
                                            <span th:text="${dir.ciudad + ', ' + dir.departamento}">Lima, Lima</span>
                                        </p>
                                        <p class="mb-0">
                                            <i class="bi bi-telephone me-2"></i>
                                            <span th:text="${dir.telefono}">987654321</span>
                                        </p>
                                    </div>
                                </label>
                            </div>

                            <!-- Agregar Nueva Direcci√≥n -->
                            <div class="text-center mt-3">
                                <a th:href="@{/mi-cuenta/direcciones/nueva}" class="btn-add-address">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Usar otra direcci√≥n
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- M√©todo de Pago -->
                    <div class="checkout-section">
                        <h3 class="section-title">
                            <i class="bi bi-credit-card-fill"></i>
                            M√©todo de Pago
                        </h3>

                        <!-- Tarjeta de Cr√©dito/D√©bito -->
                        <label class="payment-method selected">
                            <input type="radio"
                                   name="metodoPago"
                                   value="TARJETA"
                                   checked
                                   onchange="selectPayment(this)">
                            <i class="bi bi-credit-card-2-front payment-icon"></i>
                            <div class="payment-details">
                                <div class="payment-title">Tarjeta de Cr√©dito/D√©bito</div>
                                <div class="payment-description">Visa, Mastercard, American Express</div>
                            </div>
                        </label>

                        <!-- Yape / Plin -->
                        <label class="payment-method">
                            <input type="radio"
                                   name="metodoPago"
                                   value="YAPE"
                                   onchange="selectPayment(this)">
                            <i class="bi bi-phone payment-icon"></i>
                            <div class="payment-details">
                                <div class="payment-title">Yape / Plin</div>
                                <div class="payment-description">Pago r√°pido con tu celular</div>
                            </div>
                        </label>

                        <!-- Transferencia Bancaria -->
                        <label class="payment-method">
                            <input type="radio"
                                   name="metodoPago"
                                   value="TRANSFERENCIA"
                                   onchange="selectPayment(this)">
                            <i class="bi bi-bank payment-icon"></i>
                            <div class="payment-details">
                                <div class="payment-title">Transferencia Bancaria</div>
                                <div class="payment-description">Te enviaremos los datos por email</div>
                            </div>
                        </label>

                        <!-- Contra Entrega -->
                        <label class="payment-method">
                            <input type="radio"
                                   name="metodoPago"
                                   value="CONTRA_ENTREGA"
                                   onchange="selectPayment(this)">
                            <i class="bi bi-cash-coin payment-icon"></i>
                            <div class="payment-details">
                                <div class="payment-title">Pago Contra Entrega</div>
                                <div class="payment-description">Paga cuando recibas tu pedido</div>
                            </div>
                        </label>
                    </div>

                    <!-- Cup√≥n de Descuento -->
                    <div class="checkout-section">
                        <h3 class="section-title">
                            <i class="bi bi-ticket-perforated-fill"></i>
                            ¬øTienes un cup√≥n de descuento?
                        </h3>

                        <div class="cupon-section">
                            <div class="alert alert-info mb-3" style="border-radius: 15px;">
                                <i class="bi bi-lightning-charge-fill me-2"></i>
                                <strong>CyberWOW Activo:</strong> Usa <strong>CYBERWOW30</strong> para 30% OFF
                                o <strong>CYBER50</strong> para 50% OFF en compras +S/200
                            </div>

                            <div class="cupon-input-group">
                                <i class="bi bi-hash"></i>
                                <input type="text"
                                       name="codigoCupon"
                                       class="form-control"
                                       placeholder="Ingresa tu c√≥digo de cup√≥n"
                                       id="codigoCupon">
                                <button type="button"
                                        class="btn btn-warning"
                                        onclick="aplicarCupon()">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Aplicar
                                </button>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle me-1"></i>
                                Cupones disponibles: <strong>CYBERWOW30</strong>, <strong>CYBER50</strong>, <strong>CYBERENVIO</strong>
                            </small>
                        </div>
                    </div>

                </div>

                <!-- Resumen del Pedido -->
                <div class="col-lg-5">
                    <div class="order-summary">
                        <h3 class="section-title mb-4">
                            <i class="bi bi-receipt"></i>
                            Resumen del Pedido
                        </h3>

                        <!-- Items del Pedido -->
                        <div class="order-items mb-4">
                            <div class="order-item" th:each="item : ${items}">
                                <img th:src="${!item.variante.producto.imagenes.isEmpty() ?
                                              item.variante.producto.imagenes[0].urlImagen :
                                              '/images/no-image.jpg'}"
                                     th:alt="${item.variante.producto.nombre}"
                                     class="order-item-image">

                                <div class="order-item-details">
                                    <div class="order-item-name"
                                         th:text="${item.variante.producto.nombre}">
                                        Producto
                                    </div>
                                    <div class="order-item-variant">
                                        <span th:text="${item.variante.talla}">M</span> |
                                        <span th:text="${item.variante.color}">Rojo</span> |
                                        Cant: <span th:text="${item.cantidad}">1</span>
                                    </div>
                                </div>

                                <div class="order-item-price"
                                     th:text="'S/ ' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}">
                                    S/ 89.90
                                </div>
                            </div>
                        </div>

                        <!-- C√°lculos -->
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <strong th:text="'S/ ' + ${#numbers.formatDecimal(subtotal, 1, 2)}">
                                S/ 0.00
                            </strong>
                        </div>

                        <div class="summary-row">
                            <span>Costo de Env√≠o:</span>
                            <input type="hidden" name="costoEnvio" th:value="${costoEnvio}">
                            <strong th:if="${costoEnvio > 0}"
                                    th:text="'S/ ' + ${#numbers.formatDecimal(costoEnvio, 1, 2)}">
                                S/ 15.00
                            </strong>
                            <strong th:if="${costoEnvio == 0}" class="text-success">
                                <i class="bi bi-check-circle me-1"></i>GRATIS
                            </strong>
                        </div>

                        <div class="summary-row text-success" id="descuentoRow" style="display: none;">
                            <span>Descuento:</span>
                            <strong id="descuentoMonto">- S/ 0.00</strong>
                        </div>

                        <div class="summary-row total">
                            <span>TOTAL:</span>
                            <span th:text="'S/ ' + ${#numbers.formatDecimal(total, 1, 2)}">
                                S/ 0.00
                            </span>
                        </div>

                        <!-- Bot√≥n Realizar Pedido -->
                        <button type="submit"
                                class="btn btn-place-order"
                                id="btnPlaceOrder"
                                th:disabled="${direcciones.isEmpty()}">
                            <i class="bi bi-lock-fill me-2"></i>
                            Realizar Pedido Seguro
                        </button>

                        <!-- Checkout Seguro -->
                        <div class="secure-checkout">
                            <i class="bi bi-shield-check"></i>
                            <p class="mb-1"><strong>Compra 100% Segura</strong></p>
                            <p>Tus datos est√°n protegidos con encriptaci√≥n SSL</p>
                        </div>
                    </div>
                </div>

            </div>
        </form>

    </div>
</section>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function aplicarCupon() {
        const codigoCupon = document.getElementById('codigoCupon').value.trim().toUpperCase();

        if (!codigoCupon) {
            alert('Por favor, ingresa un c√≥digo de cup√≥n');
            return;
        }

        // Validaci√≥n mejorada con los nuevos cupones CyberWOW
        const cuponesValidos = {
            'CYBERWOW30': { tipo: 'porcentaje', valor: 30, minimo: 100 },
            'CYBER50': { tipo: 'porcentaje', valor: 50, minimo: 200 },
            'CYBERENVIO': { tipo: 'fijo', valor: 15, minimo: 50 }
        };

        const cupon = cuponesValidos[codigoCupon];

        if (cupon) {
            // Obtener el subtotal actual
            const subtotalText = document.querySelector('[th\\:text*="subtotal"]')?.textContent || 'S/ 0.00';
            const subtotal = parseFloat(subtotalText.replace('S/', '').replace(',', '').trim());

            if (subtotal < cupon.minimo) {
                alert(`Este cup√≥n requiere una compra m√≠nima de S/ ${cupon.minimo}. Tu subtotal actual es S/ ${subtotal.toFixed(2)}`);
                return;
            }

            let descuento = 0;
            if (cupon.tipo === 'porcentaje') {
                descuento = (subtotal * cupon.valor) / 100;
            } else {
                descuento = cupon.valor;
            }

            // Mostrar descuento
            document.getElementById('descuentoRow').style.display = 'flex';
            document.getElementById('descuentoMonto').textContent = '- S/ ' + descuento.toFixed(2);

            alert(`¬°Cup√≥n CyberWOW aplicado exitosamente! üéâ\nDescuento: ${cupon.tipo === 'porcentaje' ? cupon.valor + '%' : 'S/ ' + cupon.valor}`);
        } else {
            alert('‚ùå Cup√≥n inv√°lido o expirado.\n\nCupones CyberWOW v√°lidos:\n‚Ä¢ CYBERWOW30 (30% OFF, compra m√≠n. S/100)\n‚Ä¢ CYBER50 (50% OFF, compra m√≠n. S/200)\n‚Ä¢ CYBERENVIO (S/15 OFF, compra m√≠n. S/50)');
        }
    }
</script>

</body>
</html>